<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Related Stories</title>
  <link rel="stylesheet" href="search.css">
  <style>
    .story-list { margin: 32px auto; max-width: 700px; }
    .story-item { background: #f7f7f7; border-radius: 8px; margin-bottom: 24px; padding: 18px 22px; box-shadow: 0 1px 4px rgba(0,0,0,0.04); }
    .story-title { font-size: 1.2em; font-weight: bold; color: #0046AD; margin-bottom: 6px; }
    .story-summary { color: #333; margin-bottom: 8px; }
    .story-link { color: #1976d2; text-decoration: none; font-weight: 500; }
    .story-link:hover { text-decoration: underline; }
    .no-stories { color: #c00; font-size: 1.1em; margin-top: 32px; }
  </style>
</head>
<body>
  <div class="banner-bar">
    <img src="images/logo.png" alt="Logo" class="banner-logo" />
    <span id="branding-text" class="branding-text">Seattle Public Utilities Data Catalog</span>
  </div>
  <div id="dataset-title" style="font-size:1.4em;font-weight:bold;margin:32px auto 12px auto;max-width:700px;"></div>
  <div class="story-list" id="story-list">
    <p>Loading related stories...</p>
  </div>
  <script>
/*! ucsv v1.2.0 2014-04-09
 * Copyright 2014 Peter Johnson
 * Licensed MIT, GPL-3.0
 * https://github.com/uselesscode/ucsv
 */
var CSV=function(){"use strict";var a=/^\d+$/,b=/^\d*\.\d+$|^\d+\.\d*$/,c=/^\s|\s$|,|"|\n/,d=function(){return String.prototype.trim?function(a){return a.trim()}:function(a){return a.replace(/^\s*/,"" ).replace(/\s*$/,"")}}(),e=function(a){return"[object Number]"===Object.prototype.toString.apply(a)},f=function(a){return"[object String]"===Object.prototype.toString.apply(a)},g=function(a){return"\n"!==a.charAt(a.length-1)?a:a.substring(0,a.length-1)},h=function(d){return f(d)?(d=d.replace(/"/g,'""'),c.test(d)||a.test(d)||b.test(d)?d='"'+d+'"':""===d&&(d='""')):d=e(d)?d.toString(10):null===d||void 0===d?"":d.toString(),d},i={arrayToCsv:function(a){var b,c,d,e,f="";for(d=0;d<a.length;d+=1){for(c=a[d],e=0;e<c.length;e+=1)b=c[e],b=h(b),f+=e<c.length-1?b+",":b;f+="\n"}return f},csvToArray:function(c,e){c=g(c),e=e===!0?{trim:!0}:e||{};var f,h="",i=!1,j=!1,k="",l=[],m=[],n=e.trim===!0?!0:!1,o=function(c){var e=d(c);return j!==!0&&(""===c?c=null:n===!0&&(c=e),(a.test(e)||b.test(e))&&(c=+e)),c};for(f=0;f<c.length;f+=1)h=c.charAt(f),i!==!1||","!==h&&"\n"!==h?'"'!==h?k+=h:i?'"'===c.charAt(f+1)?(k+='"',f+=1):i=!1:(i=!0,j=!0):(k=o(k),l.push(k),"\n"===h&&(m.push(l),l=[]),k="",j=!1);return k=o(k),l.push(k),m.push(l),m},csvToObject:function(a,b){b=void 0!==b?b:{};var c=b.columns,d=!!b.trim,e=this.csvToArray(a,d);return c||(c=e.shift()),e.map(function(a){for(var b={},d=0,e=c.length;e>d;d+=1)b[c[d]]=a[d];return b})},objectToCsv:function(a,b){b=void 0!==b?b:{};var c=b.columns,d=b.includeColumns,e="",f="",g=function(b){var d,e,f,g="",i=a.length,j=c.length;for(e=0;i>e;e+=1){for(b=a[e],f=0;j>f;f+=1)d=c[f],g+=h(b[d]),g+=j-1>f?",":"";g+="\n"}return g},i=function(){var b,d,e,f,g,i,j,k=[],l=a.length,m=[];for(g=0;l>g;g+=1){e=a[g],j=[];for(f in e)e.hasOwnProperty(f)&&(i=k.indexOf(f),-1===i&&(i=k.push(f),i-=1),j[i]=h(e[f]));0===g&&(b=j.length),m.push(j)}return d=k.length,b!==d&&m.forEach(function(a){a.length=d}),c=k,m.map(function(a){return a.join(",")}).join("\n")+"\n"};return d=void 0===d?!0:!!d,e=void 0!==c?g():i(),d&&(c.forEach(function(a){f+=h(a)+","}),f=f.substring(0,f.length-1),e=f+"\n"+e),e}};return"object"==typeof exports&&(exports.arrayToCsv=i.arrayToCsv,exports.csvToArray=i.csvToArray,exports.objectToCsv=i.objectToCsv,exports.csvToObject=i.csvToObject),i}();
function uCSV(url, success, error) {
  var xhr = new XMLHttpRequest();
  xhr.open('GET', url, true);
  xhr.onreadystatechange = function() {
    if (xhr.readyState === 4) {
      if (xhr.status === 200 || (xhr.status === 0 && xhr.responseText)) {
        try {
          var data = CSV.csvToObject(xhr.responseText);
          success(data);
        } catch (e) {
          if (error) error(e);
        }
      } else {
        if (error) error(xhr.status);
      }
    }
  };
  xhr.send();
}
  </script>
  <script src="https://use.fontawesome.com/releases/v5.3.1/js/all.js" crossorigin="anonymous" defer></script>
  <script defer>
    // --- DEBUG: Check if uCSV is loaded ---
    if (typeof uCSV === 'undefined') {
      document.getElementById('story-list').innerHTML = '<div class="no-stories">uCSV library not loaded. Check script order or file path.</div>';
      console.error('uCSV is not defined!');
    } else {
      // --- DEBUG: Try loading the CSV directly ---
      uCSV('related_stories.csv', function(data) {
        console.log('[DEBUG] Test uCSV load:', data);
      }, function(error) {
        console.error('[DEBUG] Test uCSV error:', error);
      });
    }
    function getParameterByName(name, url) {
      if (!url) url = window.location.href;
      name = name.replace(/[\[\]]/g, "\\$&");
      var regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)"),
        results = regex.exec(url);
      if (!results) return null;
      if (!results[2]) return "";
      return decodeURIComponent(results[2].replace(/\+/g, " ")).trim();
    }
    function renderStories(stories) {
      var container = document.getElementById('story-list');
      if (!stories.length) {
        container.innerHTML = '<div class="no-stories">No related stories found for this dataset.</div>';
        return;
      }
      container.innerHTML = stories.map(function(story) {
        return `<div class="story-item">
          <div class="story-title">${story.title}</div>
          <div class="story-summary">${story.summary}</div>
          <a class="story-link" href="${story.url}" target="_blank" rel="noopener noreferrer">Read Full Story <i class="fas fa-external-link-alt"></i></a>
        </div>`;
      }).join('');
    }
    function loadStories(packageId) {
      console.log('Checking uCSV:', typeof uCSV);
      uCSV('related_stories.csv', function(data) {
        console.log('uCSV success, data:', data);
        var stories = data.filter(function(row) {
          return row.package_id === packageId;
        });
        console.log('Filtered stories:', stories);
        renderStories(stories);
      }, function(error) {
        console.error('uCSV error:', error);
        document.getElementById('story-list').innerHTML = '<div class="no-stories">Failed to load related stories.</div>';
      });
    }
    function displayDatasetTitleFromQuery() {
      var title = getParameterByName('title');
      var titleDiv = document.getElementById('dataset-title');
      if (title) {
        titleDiv.textContent = `Related Stories for: ${title}`;
      } else {
        titleDiv.textContent = '';
      }
    }
    document.addEventListener('DOMContentLoaded', function() {
      var pkgId = getParameterByName('package_id');
      displayDatasetTitleFromQuery();
      if (!pkgId) {
        document.getElementById('story-list').innerHTML = '<div class="no-stories">No package specified.</div>';
        return;
      }
      loadStories(pkgId);
    });
  </script>
</body>
</html>
